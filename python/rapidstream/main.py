import click
import json
import os
from pyverilog.vparser.parser import parse

from rapidstream.parser.tapa_parser import parse_tapa_output_rtl
from rapidstream.opt import islandize_vertices
from rapidstream.util import setup_logging, create_xo, dump_files
from rapidstream.backend.split import annotate_io_orientation
from rapidstream.backend.synth import setup_island_synth
from rapidstream.backend.place import setup_island_init_placement

@click.command()
@click.option(
  '--top-rtl-path',
  required=True,
  help='Path to the top-level RTL generated by TAPA.'
)
@click.option(
  '--post-floorplan-config-path',
  required=True,
  help='Path to the configuration file generated by AutoBridge.'
)
@click.option(
  '--top-name',
  required=True,
  help='Name of the top function.'
)
@click.option(
  '--xo-path',
  required=True,
  help='the xo file created by tapa.'
)
@click.option(
  '--output-dir',
  required=True,
)
@click.option(
  '--hmss-shell-dir',
  required=True,
)
def main(
  top_rtl_path: str,
  post_floorplan_config_path: str,
  top_name: str,
  xo_path: str,
  output_dir: str,
  hmss_shell_dir: str,
):
  """Entry point for RapidStream that targets TAPA"""
  output_dir = os.path.abspath(output_dir)
  os.makedirs(output_dir, exist_ok=True)

  setup_logging()

  config = json.load(open(post_floorplan_config_path, 'r'))
  ast_root, _ = parse([top_rtl_path])

  parse_tapa_output_rtl(config, ast_root)

  open(f'{output_dir}/pre_rapidstream.json', 'w').write(json.dumps(config, indent=2))

  name_to_file, name_to_dummy_file = islandize_vertices(config, top_name, use_anchor_wrapper=True)
  create_xo(top_name, xo_path, name_to_file, output_dir, xo_suffix = '_rapidstream', temp_dir='temp_orig_xo')
  create_xo(top_name, xo_path, name_to_dummy_file, output_dir, xo_suffix = '_rapidstream_dummy', temp_dir='temp_dummy_xo')
  dump_files(name_to_file, f'{output_dir}/wrapper_rtl')
  dump_files(name_to_dummy_file, f'{output_dir}/dummy_wrapper_rtl')

  open(f'{output_dir}/rapidstream.json', 'w').write(json.dumps(config, indent=2))

  annotate_io_orientation(config)

  open(f'{output_dir}/rapidstream_with_io_orientation.json', 'w').write(json.dumps(config, indent=2))

  setup_island_synth(
    config,
    f'{output_dir}/temp_orig_xo/ip_repo/haoda_xrtl_{top_name}_1_0/src/',
    f'{output_dir}/backend/synth',
  )

  setup_island_init_placement(
    config,
    f'{output_dir}/backend/synth',
    f'{output_dir}/backend/init_placement',
    hmss_shell_dir,
    top_name,
  )

if __name__ == '__main__':
  main()
